name: Sync to GitLab Mirror

on:
  push:
    branches:
      - '**'
    tags:
      - '**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  other:
    runs-on: ubuntu-latest
    steps:
      - name: Check required secrets
        run: |
          missing=""
          if [ -z "${{ secrets.GITLAB_MIRROR_URL }}" ]; then
            missing="${missing}  - GITLAB_MIRROR_URL: The GitLab repository URL (e.g., https://gitlab.com/username/repo.git)\n"
          fi
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            missing="${missing}  - GITLAB_TOKEN: A GitLab personal access token with write_repository scope\n"
          fi
          if [ -n "$missing" ]; then
            echo "::error::Missing required secrets for GitLab sync:"
            printf "$missing" >&2
            echo ""
            echo "To configure:"
            echo "  1. Go to your GitLab account -> Settings -> Access Tokens"
            echo "  2. Create a token with 'write_repository' scope"
            echo "  3. In this GitHub repo, go to Settings -> Secrets and variables -> Actions"
            echo "  4. Add GITLAB_MIRROR_URL (e.g., https://gitlab.com/username/repo.git)"
            echo "  5. Add GITLAB_TOKEN with your GitLab access token"
            exit 1
          fi

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Push to GitLab mirror
        run: |
          # Extract host from URL for credential configuration
          gitlab_host=$(echo "${{ secrets.GITLAB_MIRROR_URL }}" | sed -E 's|https?://([^/]+).*|\1|')

          # Configure git credentials
          git config --global credential.helper store
          echo "https://oauth2:${{ secrets.GITLAB_TOKEN }}@${gitlab_host}" > ~/.git-credentials

          # Add GitLab remote
          git remote add gitlab "${{ secrets.GITLAB_MIRROR_URL }}"

          # Push all branches and tags
          git push gitlab --all --force
          git push gitlab --tags --force

          # Cleanup credentials
          rm -f ~/.git-credentials
